<!DOCTYPE html>
<html>
  <head>
    <title>Wanderer - Live Dashboard</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .header {
        background: #2c3e50;
        color: white;
        padding: 1rem 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .logo {
        font-size: 1.8em;
        font-weight: bold;
        color: #3498db;
      }
      .nav {
        display: flex;
        gap: 20px;
      }
      .nav a {
        color: white;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        transition: background 0.3s;
      }
      .nav a:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .widget {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .widget-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
      }
      .widget-refresh {
        background: none;
        border: none;
        color: #3498db;
        cursor: pointer;
        font-size: 0.9em;
      }
      .widget-refresh:hover {
        text-decoration: underline;
      }

      .weather-widget {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 132, 227, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .weather-widget::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 70%
        );
        animation: weatherPulse 4s ease-in-out infinite;
      }
      @keyframes weatherPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.3;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.1;
        }
      }
      .weather-temp {
        font-size: 4em;
        font-weight: bold;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 1;
      }
      .weather-desc {
        font-size: 1.3em;
        margin-bottom: 15px;
        text-transform: capitalize;
        position: relative;
        z-index: 1;
      }
      .weather-details {
        display: flex;
        gap: 20px;
        font-size: 1em;
        opacity: 0.95;
        position: relative;
        z-index: 1;
      }
      .weather-details span {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.9em;
      }
      .weather-location {
        font-size: 1.1em;
        margin-bottom: 15px;
        opacity: 0.9;
        position: relative;
        z-index: 1;
      }

      .market-widget .market-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .market-item:last-child {
        border-bottom: none;
      }
      .market-change.positive {
        color: #27ae60;
      }
      .market-change.negative {
        color: #e74c3c;
      }

      .crypto-widget .crypto-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .crypto-item:last-child {
        border-bottom: none;
      }
      .crypto-price {
        font-weight: bold;
      }
      .crypto-change {
        font-size: 0.9em;
      }

      .news-section {
        margin-top: 30px;
      }
      .news-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .news-tab {
        padding: 10px 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .news-tab.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }
      .news-tab:hover {
        background: #f8f9fa;
      }
      .news-tab.active:hover {
        background: #2980b9;
      }

      .news-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
      }
      .news-item {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }
      .news-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }
      .news-item.smart-result {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid #3498db;
        position: relative;
      }
      .news-item.smart-result::before {
        content: "ü§ñ";
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.2em;
        opacity: 0.6;
      }
      .news-item.weather-result {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        border-left: 4px solid #0061e0;
      }
      .news-item.weather-result .news-title a {
        color: white;
      }
      .news-item.crypto-result {
        background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
        color: white;
        border-left: 4px solid #d63031;
      }
      .news-item.crypto-result .news-title a {
        color: white;
      }
      .news-item.product-result {
        background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        color: white;
        border-left: 4px solid #5f3dc4;
      }
      .news-item.product-result .news-title a {
        color: white;
      }
      .news-item.knowledge-result {
        background: linear-gradient(135deg, #55a3ff 0%, #3742fa 100%);
        color: white;
        border-left: 4px solid #2f3542;
      }
      .news-item.knowledge-result .news-title a {
        color: white;
      }

      /* New content type styles */
      .news-item.world-headline {
        border-left: 4px solid #e74c3c;
        background: linear-gradient(135deg, #fff 0%, #ffeaa7 100%);
      }
      .news-item.bigtech-story {
        border-left: 4px solid #6c5ce7;
        background: linear-gradient(135deg, #fff 0%, #e8f4f8 100%);
      }
      .news-item.local-data {
        border-left: 4px solid #00b894;
        background: linear-gradient(135deg, #fff 0%, #e8f8f5 100%);
      }

      /* Badges */
      .importance-badge,
      .tech-badge,
      .weather-badge,
      .market-badge {
        font-size: 0.8em;
        padding: 2px 6px;
        border-radius: 8px;
        margin-left: 8px;
      }
      .importance-badge {
        background: #e74c3c;
        color: white;
      }
      .tech-badge {
        background: #6c5ce7;
        color: white;
      }
      .weather-badge {
        background: #74b9ff;
        color: white;
      }
      .market-badge {
        background: #00b894;
        color: white;
      }

      .news-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #2c3e50;
      }
      .news-title a {
        color: inherit;
        text-decoration: none;
      }
      .news-title a:hover {
        color: #3498db;
      }

      .news-meta {
        display: flex;
        gap: 15px;
        font-size: 0.9em;
        color: #666;
        margin-bottom: 15px;
        align-items: center;
      }
      .news-source {
        background: #95a5a6;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
      }
      .news-time {
        color: #7f8c8d;
      }

      .news-description {
        color: #555;
        margin-bottom: 15px;
        font-size: 0.95em;
      }
      .news-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: 5px;
        margin-bottom: 15px;
      }

      .search-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .search-bar input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      .search-bar button {
        padding: 12px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      .search-bar button:hover {
        background: #2980b9;
      }

      .repo-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      .repo-item:last-child {
        border-bottom: none;
      }
      .repo-name {
        font-weight: bold;
        color: #3498db;
      }
      .repo-desc {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
      }
      .repo-stats {
        display: flex;
        gap: 15px;
        font-size: 0.9em;
        color: #666;
        align-items: center;
      }

      .loading {
        text-align: center;
        padding: 40px;
      }
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .load-more {
        text-align: center;
        margin: 30px 0;
      }
      .load-more button {
        padding: 12px 30px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      .load-more button:hover {
        background: #2980b9;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #7f8c8d;
      }
      .empty-state h3 {
        margin-bottom: 10px;
      }

      .article-actions {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }

      .fetch-article-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background 0.3s;
      }

      .fetch-article-btn:hover {
        background: #2980b9;
      }

      .fetch-article-btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
      }

      .full-article-content {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #3498db;
      }

      .article-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #856404;
      }

      .article-warning strong {
        color: #d63031;
      }

      .article-content {
        line-height: 1.6;
        color: #2c3e50;
      }

      .article-meta-info {
        font-size: 0.8em;
        color: #7f8c8d;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ddd;
      }

      .loading-article {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #7f8c8d;
      }

      .loading-article .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #ddd;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 15px;
        }
        .nav {
          justify-content: center;
        }
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        .news-grid {
          grid-template-columns: 1fr;
        }
        .search-bar {
          flex-direction: column;
        }
        .news-tabs {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo">üöÄ Wanderer</div>
        <nav class="nav">
          <a href="/">Dashboard</a>
          <a href="/admin">Admin Portal</a>
        </nav>
      </div>
    </div>

    <div class="container">
      <div class="dashboard-grid">
        <div class="widget weather-widget">
          <div class="widget-header">
            <div class="widget-title">üå§Ô∏è Weather</div>
            <button class="widget-refresh" onclick="loadWeather()">
              Refresh
            </button>
          </div>
          <div id="weatherContent">
            <div class="loading">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>

        <div class="widget market-widget">
          <div class="widget-header">
            <div class="widget-title">üìà Markets</div>
            <button class="widget-refresh" onclick="loadMarket()">
              Refresh
            </button>
          </div>
          <div id="marketContent">
            <div class="loading">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>

        <div class="widget crypto-widget">
          <div class="widget-header">
            <div class="widget-title">‚Çø Crypto</div>
            <button class="widget-refresh" onclick="loadCrypto()">
              Refresh
            </button>
          </div>
          <div id="cryptoContent">
            <div class="loading">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="search-section">
        <div class="search-bar">
          <input
            type="text"
            id="searchInput"
            placeholder="Try: 'weather in New York', 'cheapest airpods', 'bitcoin price', 'latest tech news', 'world headlines'..."
          />
          <button onclick="performSearch()">Search</button>
        </div>
      </div>

      <div class="news-section">
        <div class="news-tabs">
          <button
            class="news-tab active"
            data-tab="scraped"
            onclick="switchTab('scraped')"
          >
            üîÑ Scraping Articles
          </button>
          <button
            class="news-tab"
            data-tab="world"
            onclick="switchTab('world')"
          >
            üåç World Headlines
          </button>
          <button
            class="news-tab"
            data-tab="bigtech"
            onclick="switchTab('bigtech')"
          >
            üíª Big Technology
          </button>
          <button
            class="news-tab"
            data-tab="local"
            onclick="switchTab('local')"
          >
            üìç Local Area Data
          </button>
        </div>

        <div class="news-grid" id="newsContent">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading latest news...</p>
          </div>
        </div>
      </div>

      <div class="load-more" id="loadMore" style="display: none">
        <button onclick="loadMoreArticles()">Load More</button>
      </div>
    </div>

    <script>
      let currentPage = 1;
      let currentCategory = 'all';
      let currentSearch = '';
      let currentTab = 'scraped';
      let totalPages = 1;
      let isLoading = false;

      // JavaScript functions start here

      // Load market data
      async function loadMarket() {
          try {
              const response = await fetch('/api/market');
              const market = await response.json();

              document.getElementById('marketContent').innerHTML = market.indices.map(index => `
                  <div class="market-item">
                      <span>${index.name}</span>
                      <div>
                          <span>${index.value}</span>
                          <span class="market-change ${index.change.startsWith('+') ? 'positive' : 'negative'}">${index.change}</span>
                      </div>
                  </div>
              `).join('');
          } catch (error) {
              document.getElementById('marketContent').innerHTML = `
                  <div class="empty-state">
                      <h3>Market data unavailable</h3>
                  </div>
              `;
          }
      }

      // Load crypto data
      async function loadCrypto() {
          try {
              const response = await fetch('/api/crypto');
              const data = await response.json();

              document.getElementById('cryptoContent').innerHTML = data.crypto.map(coin => `
                  <div class="crypto-item">
                      <div>
                          <div class="crypto-name">${coin.name}</div>
                      </div>
                      <div>
                          <div class="crypto-price">$${coin.price ? coin.price.toFixed(2) : '--'}</div>
                          <div class="crypto-change ${coin.change24h >= 0 ? 'positive' : 'negative'}">${coin.change24h ? coin.change24h.toFixed(2) : '0.00'}%</div>
                      </div>
                  </div>
              `).join('');
          } catch (error) {
              document.getElementById('cryptoContent').innerHTML = `
                  <div class="empty-state">
                      <h3>Crypto data unavailable</h3>
                  </div>
              `;
          }
      }

      // Switch between news tabs
      function switchTab(tab) {
          currentTab = tab;
          document.querySelectorAll('.news-tab').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.tab === tab);
          });

          loadContent(tab);
      }

      // Load content based on tab
      async function loadContent(tab) {
          const newsContent = document.getElementById('newsContent');
          newsContent.innerHTML = `
              <div class="loading">
                  <div class="loading-spinner"></div>
                  <p>Loading ${tab} content...</p>
              </div>
          `;

          try {
              let data;
              switch(tab) {
                  case 'scraped':
                      data = await loadScrapedArticles();
                      break;
                  case 'world':
                      data = await loadWorldHeadlines();
                      break;
                  case 'bigtech':
                      data = await loadBigTechNews();
                      break;
                  case 'local':
                      data = await loadLocalAreaData();
                      break;
              }

              if (data && data.length > 0) {
                  newsContent.innerHTML = data.map(item => createNewsItem(item, tab)).join('');
              } else {
                  newsContent.innerHTML = `
                      <div class="empty-state">
                          <h3>No content available</h3>
                          <p>Check back later for updates</p>
                      </div>
                  `;
              }
          } catch (error) {
              newsContent.innerHTML = `
                  <div class="empty-state">
                      <h3>Error loading content</h3>
                      <p>Please try again later</p>
                  </div>
              `;
          }
      }

      // Load scraped articles
      async function loadScrapedArticles() {
          const response = await fetch('/api/news?limit=20');
          const data = await response.json();
          return data.articles;
      }

      // Load major events
      async function loadMajorEvents() {
          const response = await fetch('/api/major-events');
          const data = await response.json();
          return data.events;
      }

      // Load tech news
      async function loadTechNews() {
          const response = await fetch('/api/tech-news');
          const data = await response.json();
          return data.news;
      }

      // Load trending tech
      async function loadTrendingTech() {
          const response = await fetch('/api/trending-tech');
          const data = await response.json();
          return data.trending;
      }

      // Load trending repos
      async function loadTrendingRepos() {
          const response = await fetch('/api/trending-repos');
          const data = await response.json();
          return data.repos;
      }

      // Load sports news
      async function loadSportsNews() {
          const response = await fetch('/api/sports-news');
          const data = await response.json();
          return data.sports;
      }

      // Load world headlines
      async function loadWorldHeadlines() {
          const response = await fetch('/api/world-headlines');
          const data = await response.json();
          return data.headlines;
      }

      // Load big tech news
      async function loadBigTechNews() {
          const response = await fetch('/api/big-tech');
          const data = await response.json();
          return data.bigTech;
      }

      // Load local area data
      async function loadLocalAreaData() {
          try {
              // Try to get location from IP first
              let locationData = null;
              try {
                  const locationResponse = await fetch('/api/location');
                  locationData = await locationResponse.json();
              } catch (error) {
                  console.log('Could not get location from IP for local data:', error);
              }

              let url = '/api/local-area';
              if (locationData && locationData.lat && locationData.lon) {
                  url = `/api/local-area?lat=${locationData.lat}&lon=${locationData.lon}`;
              }

              const response = await fetch(url);
              const data = await response.json();
              return data.localData;
          } catch (error) {
              console.error('Error loading local area data:', error);
              return [];
          }
      }

      // Load breaking news (legacy)
      async function loadBreakingNews() {
          const response = await fetch('/api/breaking-news');
          const data = await response.json();
          return data.breaking;
      }

      // Create news item HTML
      function createNewsItem(item, type) {
          const timeAgo = getTimeAgo(new Date(item.publishedAt || item.timestamp));

          // Handle different content types
          let additionalClass = '';
          let additionalContent = '';

          if (type === 'world') {
              additionalClass = 'world-headline';
              additionalContent = item.importance === 'high' ? '<span class="importance-badge">üî¥ Important</span>' : '';
          } else if (type === 'bigtech') {
              additionalClass = 'bigtech-story';
              additionalContent = item.category === 'big-tech' ? '<span class="tech-badge">üíª Tech</span>' : '';
          } else if (type === 'local') {
              additionalClass = 'local-data';
              if (item.category === 'weather') {
                  additionalContent = '<span class="weather-badge">üå§Ô∏è Weather</span>';
              } else if (item.category === 'market') {
                  additionalContent = '<span class="market-badge">üìà Market</span>';
              }
          }

          if (type === 'repos') {
              return `
                  <div class="news-item ${additionalClass}">
                      <div class="news-title">
                          <a href="${item.url}" target="_blank">${item.name}</a>
                      </div>
                      <div class="news-meta">
                          <span class="news-source">${item.owner}</span>
                          <span class="news-time">${item.language || 'Unknown'}</span>
                      </div>
                      <div class="news-description">${item.description || 'No description available'}</div>
                      <div class="repo-stats">
                          <span>‚≠ê ${item.stars}</span>
                          <span>üìÇ ${item.fullName}</span>
                      </div>
                  </div>
              `;
          }

          return `
              <div class="news-item ${additionalClass}">
                  ${item.image ? `<img src="${item.image}" alt="Article image" class="news-image" onerror="this.style.display='none'">` : ''}
                  <div class="news-title">
                      <a href="${item.url}" target="_blank">${item.headline || item.title}</a>
                  </div>
                  <div class="news-meta">
                      <span class="news-source">${item.source || item.category}</span>
                      <span class="news-time">${timeAgo}</span>
                      ${item.score ? `<span>‚¨ÜÔ∏è ${item.score}</span>` : ''}
                      ${item.comments ? `<span>üí¨ ${item.comments}</span>` : ''}
                      ${additionalContent}
                  </div>
                  <div class="news-description">${item.description || 'No description available'}</div>
                  <div class="article-actions">
                      <button onclick="fetchFullArticle('${item.url}', this)" class="fetch-article-btn">
                          üìñ Read Full Article
                      </button>
                  </div>
                  <div class="full-article-content" style="display: none;">
                      <!-- Full article content will be loaded here -->
                  </div>
              </div>
          `;
      }

      // Get time ago string
      function getTimeAgo(date) {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMins / 60);
          const diffDays = Math.floor(diffHours / 24);

          if (diffMins < 1) return 'Just now';
          if (diffMins < 60) return `${diffMins}m ago`;
          if (diffHours < 24) return `${diffHours}h ago`;
          return `${diffDays}d ago`;
      }

      // Initialize dashboard
      function initDashboard() {
          loadWeather();
          loadMarket();
          loadCrypto();
          loadContent('scraped');
      }

      // Auto-refresh widgets every 5 minutes
      setInterval(() => {
          loadWeather();
          loadMarket();
          loadCrypto();
      }, 5 * 60 * 1000);

      // Auto-refresh news every 30 seconds for dynamic content
      setInterval(() => {
          if (currentTab === 'scraped') {
              loadContent('scraped');
          } else if (currentTab === 'world') {
              loadContent('world');
          } else if (currentTab === 'bigtech') {
              loadContent('bigtech');
          } else if (currentTab === 'local') {
              loadContent('local');
          }
      }, 30000);

      // Initialize
      initDashboard();


      // Load weather data
      async function loadWeather() {
          try {
              // Get user location from IP
              let locationData = null;
              try {
                  const locationResponse = await fetch('/api/location');
                  locationData = await locationResponse.json();
              } catch (error) {
                  console.log('Could not get location from IP:', error);
              }

              let lat, lon, locationName;
              
              if (locationData && locationData.lat && locationData.lon) {
                  lat = locationData.lat;
                  lon = locationData.lon;
                  locationName = `${locationData.city}, ${locationData.region}`;
              } else if (navigator.geolocation) {
                  try {
                      const position = await new Promise((resolve, reject) => {
                          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                      });
                      lat = position.coords.latitude;
                      lon = position.coords.longitude;
                  } catch (geoError) {
                      console.log('Geolocation failed:', geoError);
                  }
              }

              const weatherUrl = lat && lon ? `/api/weather?lat=${lat}&lon=${lon}` : '/api/weather';
              const response = await fetch(weatherUrl);
              const weather = await response.json();

              const displayLocation = locationName || weather.location || 'Unknown Location';
              const locationIndicator = locationData && !locationData.isDefault ? 'üåç' : 'üìç';

              document.getElementById('weatherContent').innerHTML = `
                  <div class="weather-temp">${weather.temperature}¬∞C</div>
                  <div class="weather-desc">${weather.description}</div>
                  <div class="weather-location">${locationIndicator} ${displayLocation}</div>
                  <div class="weather-details">
                      <span>üíß ${weather.humidity}%</span>
                      <span>üí® ${weather.windSpeed || 'N/A'} m/s</span>
                      <span>üå§Ô∏è Updated</span>
                  </div>
              `;

          } catch (error) {
              console.error('Weather load error:', error);
              document.getElementById('weatherContent').innerHTML = `
                  <div class="empty-state">
                      <h3>Weather unavailable</h3>
                      <p>Unable to load weather data</p>
                  </div>
              `;
          }
      }


      // Fetch full article content
      async function fetchFullArticle(url, button) {
          const newsItem = button.closest('.news-item');
          const contentDiv = newsItem.querySelector('.full-article-content');
          
          // Show warning and get user consent
          if (!confirm('‚ö†Ô∏è WARNING: This will scrape the full article content.\n\n' +
                      '‚Ä¢ Please respect copyright and terms of service\n' +
                      '‚Ä¢ This is for personal/educational use only\n' +
                      '‚Ä¢ The publisher may detect automated access\n\n' +
                      'Do you want to continue?')) {
              return;
          }

          // Disable button and show loading
          button.disabled = true;
          button.innerHTML = '<div class="spinner"></div> Loading...';

          try {
              const response = await fetch('/api/fetch-article', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ url })
              });

              const data = await response.json();

              if (!response.ok) {
                  throw new Error(data.error || 'Failed to fetch article');
              }

              // Display the full article
              contentDiv.innerHTML = `
                  <div class="article-warning">
                      <strong>‚ö†Ô∏è Legal Notice:</strong> ${data.warning}
                  </div>
                  <div class="article-content">
                      <h3>${data.title}</h3>
                      ${data.description ? `<p><em>${data.description}</em></p>` : ''}
                      <div style="white-space: pre-wrap; margin-top: 15px;">
                          ${data.content || 'Unable to extract article content.'}
                      </div>
                  </div>
                  <div class="article-meta-info">
                      <strong>Word count:</strong> ${data.wordCount} | 
                      <strong>Fetched:</strong> ${new Date(data.fetchedAt).toLocaleString()} |
                      <strong>Source:</strong> <a href="${data.url}" target="_blank">${new URL(data.url).hostname}</a>
                      ${data.publishedDate ? `| <strong>Published:</strong> ${new Date(data.publishedDate).toLocaleDateString()}` : ''}
                  </div>
              `;

              contentDiv.style.display = 'block';
              button.innerHTML = '‚úÖ Article Loaded';
              button.style.background = '#27ae60';

              // Scroll to the article content
              contentDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

          } catch (error) {
              console.error('Article fetch error:', error);
              contentDiv.innerHTML = `
                  <div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 5px;">
                      <strong>‚ùå Failed to fetch article:</strong> ${error.message}
                      <br><br>
                      <small>This may be due to:</small>
                      <ul style="margin-top: 10px;">
                          <li>The website blocking automated access</li>
                          <li>Paywall or login requirements</li>
                          <li>Network connectivity issues</li>
                          <li>Server-side protection mechanisms</li>
                      </ul>
                  </div>
              `;
              contentDiv.style.display = 'block';
              button.innerHTML = '‚ùå Failed';
              button.style.background = '#e74c3c';
          }
      }

      // Load categories
      async function loadCategories() {
          try {
              const response = await fetch('/api/categories');
              const data = await response.json();
              const filters = document.getElementById('filters');

              if (filters) {
                  filters.innerHTML = '<button class="filter-btn active" data-category="all">All</button>';

                  data.categories.forEach(category => {
                      const btn = document.createElement('button');
                      btn.className = 'filter-btn';
                      btn.dataset.category = category;
                      btn.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                      btn.onclick = () => filterByCategory(category);
                      filters.appendChild(btn);
                  });
              }
          } catch (error) {
              console.error('Error loading categories:', error);
          }
      }

      // Load news articles
      async function loadNews(page = 1, append = false) {
          if (isLoading) return;
          isLoading = true;

          try {
              const params = new URLSearchParams({
                  page: page.toString(),
                  limit: '20'
              });

              if (currentCategory !== 'all') {
                  params.append('category', currentCategory);
              }

              const endpoint = currentSearch ? '/api/search' : '/api/news';
              if (currentSearch) {
                  params.append('q', currentSearch);
              }

              const response = await fetch(`${endpoint}?${params}`);
              const data = await response.json();

              const feed = document.getElementById('newsContent');
              const loadMore = document.getElementById('loadMore');

              if (!append) {
                  feed.innerHTML = '';
                  currentPage = 1;
              }

              if (data.articles && data.articles.length > 0) {
                  data.articles.forEach(article => {
                      const item = createNewsItemElement(article);
                      feed.appendChild(item);
                  });

                  totalPages = data.pagination.pages;
                  currentPage = data.pagination.page;

                  // Show/hide load more button
                  if (loadMore) {
                      loadMore.style.display = currentPage < totalPages ? 'block' : 'none';
                  }
              } else {
                  if (!append) {
                      feed.innerHTML = `
                          <div class="empty-state">
                              <h3>No articles found</h3>
                              <p>${currentSearch ? 'Try different search terms' : 'No articles have been scraped yet'}</p>
                          </div>
                      `;
                  }
                  if (loadMore) {
                      loadMore.style.display = 'none';
                  }
              }

          } catch (error) {
              console.error('Error loading news:', error);
              const feed = document.getElementById('newsContent');
              feed.innerHTML = '<div class="empty-state"><h3>Error loading news</h3><p>Please try again later</p></div>';
          } finally {
              isLoading = false;
          }
      }

      // Create news item element (for appendChild operations)
      function createNewsItemElement(article) {
          const item = document.createElement('div');
          item.className = 'news-item';

          const timeAgo = getTimeAgo(new Date(article.timestamp));

          item.innerHTML = `
              <div class="news-title">
                  <a href="${article.url}" target="_blank">${article.headline || article.title}</a>
              </div>
              <div class="news-meta">
                  <span class="news-category">${article.category}</span>
                  <span class="news-mode">${article.mode}</span>
                  <span class="news-time">${timeAgo}</span>
              </div>
              <div class="news-description">${article.description}</div>
              <div class="news-url">${article.url}</div>
          `;

          return item;
      }

      // Get time ago string
      function getTimeAgo(date) {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMins / 60);
          const diffDays = Math.floor(diffHours / 24);

          if (diffMins < 1) return 'Just now';
          if (diffMins < 60) return `${diffMins}m ago`;
          if (diffHours < 24) return `${diffHours}h ago`;
          return `${diffDays}d ago`;
      }

      // Filter by category
      function filterByCategory(category) {
          currentCategory = category;
          currentSearch = '';
          document.getElementById('searchInput').value = '';

          // Update active filter button
          document.querySelectorAll('.filter-btn').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.category === category);
          });

          loadNews(1, false);
      }

      // Perform search
      function performSearch() {
          const searchInput = document.getElementById('searchInput');
          currentSearch = searchInput.value.trim();
          currentCategory = 'all';

          // Reset category filter
          document.querySelectorAll('.filter-btn').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.category === 'all');
          });

          loadNews(1, false);
      }

      // Load more articles
      function loadMoreArticles() {
          if (currentPage < totalPages) {
              loadNews(currentPage + 1, true);
          }
      }

      // Enter key search
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              performSearch();
          }
      });

      // Auto-refresh every 30 seconds
      setInterval(() => {
          if (!currentSearch && currentCategory === 'all' && currentPage === 1) {
              loadNews(1, false);
          }
      }, 30000);

      // Initialize
      loadCategories();
      loadNews();
    </script>
  </body>
</html>
